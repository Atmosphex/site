<!DOCTYPE html>
<html lang=en>
<head>
  <meta name=viewport content="width=device-width, initial-scale=1">
  <meta name=theme-color content=#ffffff>
  <title>Spoopy.link</title>
  <script src=https://cdn.rawgit.com/github/fetch/c3e1/fetch.js></script>
  <link rel=stylesheet href=https://s.gus.host/fira/FiraCode.css />
  <link rel=stylesheet href=/main.css />
</head>
<body>
<div class=wrapper>
  <h1 id=header></h1>
  <div id=results><h2></h2><ol></ol></div>
  <div class=spinner><div class=cube1></div><div class=cube2></div></div>
</div>
<div class=footer>
  <a href=https://github.com/devsnek/spoopy.link>GitHub</a> |
  <a href=https://patreon.com/devsnek>Patreon</a>
</div>
<script nonce=inline>
const safe = document.querySelector('#results h2');
const list = document.querySelector('#results ol');
const heading = document.getElementById('header');

const cache = {
  get: (name) => JSON.parse(localStorage.getItem(name)),
  set: (name, value) => localStorage.setItem(name, JSON.stringify(value)),
  has: (name) => !!localStorage.getItem(name),
};

const suspect = window.location.pathname.slice(1).replace(/(^<|>$)/g, '');
heading.innerHTML = suspect;
(cache.has(suspect) ?
 Promise.resolve({ status: 200, json: () => cache.get(suspect) }) :
 fetch(`/api/v1/${suspect}`))
  .then((res) => {
    document.querySelector('.spinner').remove();
    if (res.status === 200) return res.json();
    return res.json().then(t => Promise.reject(new Error(t.error)));
  })
  .then((res) => {
    cache.set(res.chain[0].url, res);
    cache.set(suspect, res);

    safe.innerHTML = res.safe ? 'Safe' : 'Unsafe';
    heading.innerHTML = res.chain[0].url;
    for (const item of res.chain) {
      const li = document.createElement('li');
      li.textContent = `${item.url} ${item.safe ? '\u2714' : '\u274c'}`;
      list.appendChild(li);
    }
  })
  .catch((err) => {
    safe.innerHTML = err.message;
  });
</script>
<script src=/main.js></script>
</body>
</html>
