<!DOCTYPE html>
<html lang=en>
<head>
  <meta name=viewport content="width=device-width, initial-scale=1">
  <meta name=theme-color content=#ffffff>
  <title>Spoopy.link</title>
  <script src=https://cdn.rawgit.com/github/fetch/c3e1/fetch.js></script>
  <link rel=stylesheet href=https://s.gus.host/fira/FiraCode.css />
  <link rel=stylesheet href=/main.css />
</head>
<body>
<div class=wrapper>
  <h1 id=header></h1>
  <div id=results><h2></h2><ol></ol></div>
  <div class=spinner><div class=cube1></div><div class=cube2></div></div>
</div>
<div class=footer>
  <a href=https://github.com/devsnek/spoopy.link>GitHub</a> |
  <a href=https://patreon.com/devsnek>Patreon</a>
</div>
<script nonce=inline>
const safe = document.querySelector('#results h2');
const list = document.querySelector('#results ol');
const heading = document.getElementById('header');

const cache = JSON.parse(localStorage.getItem('cache')) || {};

const suspect = window.location.pathname.slice(1).replace(/(^<|>$)/g, '');
heading.innerHTML = suspect;
(cache[suspect] ?
 Promise.resolve({ status: 200, json: () => cache[suspect] }) :
 fetch(`/api/v1/${suspect}`))
  .then(r => r.status === 200 ? r.json() : r.text().then(t => Promise.reject(new Error(t))))
  .catch((err) => {
    safe.innerHTML = err.message;
  })
  .then((res) => {
    cache[res.chain[0].url] = res;
    cache[suspect] = res;
    localStorage.setItem('cache', JSON.stringify(cache));

    document.querySelector('.spinner').remove();
    safe.innerHTML = res.safe ? 'Safe' : 'Unsafe';
    heading.innerHTML = res.chain[0].url;
    for (const item of res.chain) {
      const li = document.createElement('li');
      li.textContent = `${item.url} ${item.safe ? '\u2714' : '\u274c'}`;
      list.appendChild(li);
    }
  });
</script>
<script src=/main.js></script>
</body>
</html>
